<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drink-Tracker ¬∑ BAC</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg1:#070b14; --bg2:#060915;
      --card:rgba(17, 25, 40, .55);
      --card2:rgba(17, 25, 40, .38);
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);
      --txt:#e5e7eb; --muted:#a3adc2;
      --accent:#22c55e;
      --accent2:#22d3ee;
      --warn:#7f1d1d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 6px 18px rgba(0,0,0,.25);
      --radius:18px;
      --radius2:22px;
      --shot:#a78bfa; --long:#34d399; --beer:#fbbf24; --wine:#60a5fa;
      --line:#93c5fd;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 650px at 15% -10%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(900px 650px at 90% 10%, rgba(34,197,94,.16), transparent 55%),
        radial-gradient(900px 650px at 40% 110%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(1200px 800px at 20% -10%,var(--bg1),var(--bg2)),
        var(--bg2);
    }

    /* subtle grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity="0.12"/></svg>');
      mix-blend-mode:overlay;
      opacity:.35;
    }

    .container{max-width:980px;margin:0 auto;padding:12px 16px 92px}

    header{
      position:sticky; top:0; z-index:20;
      display:flex;align-items:center;justify-content:space-between;
      margin:10px 0 12px;gap:10px;flex-wrap:wrap;
      padding:10px 10px;
      border-radius:var(--radius2);
      background:rgba(10,14,26,.55);
      border:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(14px);
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
    }

    h1{font-size:18px;margin:0;font-weight:650;letter-spacing:.2px}

    .btn{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--txt);
      padding:9px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      box-shadow: 0 1px 0 rgba(255,255,255,.06) inset;
    }
    .btn:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.14)}
    .btn:active{transform: translateY(1px) scale(.98)}
    .btn:focus-visible{outline:2px solid rgba(34,211,238,.55); outline-offset:2px}

    .btn-icon{padding:9px 10px; border-radius:999px}

    .btn-primary{
      background:rgba(34,197,94,.92);
      border-color:rgba(34,197,94,.65);
      color:#06210f;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
    }
    .btn-primary:hover{background:rgba(34,197,94,.98)}

    .grid{display:grid;gap:12px}

    .stats{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:768px){ .stats{grid-template-columns:repeat(4,minmax(0,1fr))} }

    .card{
      position:relative;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.10), transparent 28%);
      opacity:.7;
      pointer-events:none;
    }

    .stat-label{font-size:12px;color:var(--muted)}
    .stat-value{font-size:22px;font-weight:700;margin-top:2px;letter-spacing:.2px}

    .drinks{grid-template-columns:1fr}
    @media(min-width:768px){ .drinks{grid-template-columns:1fr 1fr} }

    .drink-title{font-size:16px;font-weight:650;margin:0;letter-spacing:.2px}
    .drink-sub{font-size:12px;color:rgba(227,233,245,.72)}

    .row{display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:10px}

    .counter{font-size:30px;font-weight:800;letter-spacing:.2px}

    .pill{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}

    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-top:1px solid rgba(255,255,255,.08);gap:10px}
    .list li:first-child{border-top:0}

    .muted{color:var(--muted)}

    .bottom-sheet{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);z-index:50;
      backdrop-filter: blur(6px);
      animation: fadeIn .16s ease both;
    }

    .sheet{
      background: rgba(14, 22, 38, .78);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px 22px 0 0;
      max-height: 90vh;
      overflow:auto;
      width:100%;
      max-width: 740px;
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      transform: translateY(14px);
      animation: sheetUp .18s ease both;
    }

    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes sheetUp{from{transform:translateY(18px);opacity:.88}to{transform:translateY(0);opacity:1}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}
    @keyframes sheetDown{from{transform:translateY(0);opacity:1}to{transform:translateY(18px);opacity:.92}}

    .bottom-sheet.closing{animation: fadeOut .16s ease both}
    .bottom-sheet.closing .sheet{animation: sheetDown .18s ease both}

    .input{width:100%;background:rgba(6,10,20,.65);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;color:var(--txt);
      box-shadow: 0 1px 0 rgba(255,255,255,.06) inset;
    }
    .input:focus{outline:2px solid rgba(34,211,238,.35);border-color:rgba(34,211,238,.35)}

    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}

    .legend{display:flex;flex-wrap:wrap;gap:10px;font-size:11px;margin-top:10px;color:#d1d5db}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}

    svg{display:block;width:100%}

    .banner{display:none;align-items:center;justify-content:space-between;background:rgba(127,29,29,.75);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 14px;border-radius:16px;margin-bottom:12px;gap:10px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
    }
    .banner.show{display:flex}

    .shake{animation:shake .6s}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}

    .toggle{display:flex;align-items:center;gap:10px}
    .toggle input{width:18px;height:18px}
    .hint{font-size:12px;color:rgba(227,233,245,.65)}

    /* Snackbar */
    .snackbar{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:60;display:none}
    .snackbar.show{display:block;animation: snackIn .18s ease both}
    @keyframes snackIn{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
    .snackbar .bar{background:rgba(14,22,38,.85);border:1px solid rgba(255,255,255,.10);color:var(--txt);padding:10px 12px;border-radius:16px;display:flex;gap:12px;align-items:center;
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow2);
    }
    .link{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);padding:6px 10px;border-radius:12px;cursor:pointer}

    /* micro highlight */
    .pulse{animation:pulse .55s ease}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,211,238,.0)}40%{box-shadow:0 0 0 6px rgba(34,211,238,.18)}100%{box-shadow:0 0 0 0 rgba(34,211,238,.0)}}

    @media (prefers-reduced-motion: reduce){
      *{animation:none!important;transition:none!important;scroll-behavior:auto!important}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Drink-Tracker ¬∑ BAC</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnAddManual" class="btn btn-primary btn-icon" title="Manuell hinzuf√ºgen" aria-label="Manuell hinzuf√ºgen">Ôºã</button>
        <button id="btnExport" class="btn btn-icon" title="PDF Export" aria-label="PDF Export">‚¨áÔ∏è</button>
        <button id="btnSettings" class="btn btn-icon" title="Einstellungen" aria-label="Einstellungen">‚öôÔ∏è</button>
        <button id="btnReset" class="btn btn-icon" title="Alle Eintr√§ge l√∂schen" aria-label="Alle Eintr√§ge l√∂schen" style="background:rgba(127,29,29,.35);border-color:rgba(255,255,255,.12)">‚ü≤</button>
      </div>
    </header>

    <div id="limitBanner" class="banner">
      <div>‚ö†Ô∏è Du hast dein Limit von <span id="limitVal">0</span> Drinks √ºberschritten.</div>
      <button id="closeBanner" class="btn">Okay</button>
    </div>

    <section class="grid stats" id="stats">
      <div class="card" id="card-bac">
        <div class="stat-label">Aktuell</div>
        <div class="stat-value" id="stat-bac">0.00 ‚Ä∞</div>
        <div class="muted" style="font-size:12px" id="stat-last">‚Äì</div>
      </div>
      <div class="card"><div class="stat-label">Bis ~0‚Ä∞</div><div class="stat-value" id="stat-zero">‚Äì</div></div>
      <div class="card" id="stat-grams-card"><div class="stat-label">Alkohol</div><div class="stat-value" id="stat-grams">0 g</div></div>
      <div class="card"><div class="stat-label">Start</div><div class="stat-value" id="stat-start">‚Äì</div></div>
    </section>

    <section class="grid drinks" id="controls"></section>

    <section class="card" style="margin-top:16px">
      <div class="row"><div class="drink-title">Verlauf</div><div class="muted" style="font-size:12px">(neueste oben)</div></div>
      <ul class="list" id="log"></ul>
      <div class="muted" id="log-empty">Noch keine Getr√§nke erfasst.</div>
    </section>

    <p class="muted" style="font-size:12px;margin-top:12px">Hinweis: Grober Sch√§tzer. Verlasse dich niemals ausschlie√ülich darauf, um √ºber Fahren zu entscheiden.</p>

    <section class="card" style="margin-top:16px">
      <div class="row"><div class="drink-title">Flussdiagramm</div><div class="muted" style="font-size:12px">(Zeit ‚Üí unten)</div></div>
      <div style="overflow-x:auto;margin-top:8px">
        <div style="min-width:320px">
          <svg id="flow" viewBox="0 0 640 260" height="220"></svg>
        </div>
      </div>
      <div class="legend">
        <span><span class="dot" style="background:var(--shot)"></span>Shot</span>
        <span><span class="dot" style="background:var(--long)"></span>Long Drink</span>
        <span><span class="dot" style="background:var(--beer)"></span>Bier</span>
        <span><span class="dot" style="background:var(--wine)"></span>Wein</span>
        <span style="display:flex;align-items:center;gap:6px"><svg width="20" height="10"><line x1="0" y1="5" x2="20" y2="5" stroke="var(--line)" stroke-width="2"/></svg>Kumulierte Linie</span>
      </div>
    </section>
  </div>

  <!-- Einstellungen -->
  <div class="bottom-sheet" id="sheet">
    <div class="sheet">
      <div class="row" style="margin-bottom:8px">
        <div class="drink-title">Einstellungen</div>
        <div style="display:flex;gap:8px">
          <button id="btnDefaults" class="btn">Standardwerte</button>
          <button id="btnClose" class="btn btn-primary">Fertig</button>
        </div>
      </div>

      <div class="grid-3">
        <div><label class="stat-label">Gewicht (kg)</label><input id="inWeight" type="number" class="input" inputmode="numeric" value="75"></div>
        <div><label class="stat-label">Geschlecht</label>
          <select id="inSex" class="input">
            <option value="m">m√§nnlich (r‚âà0.68)</option>
            <option value="f">weiblich (r‚âà0.55)</option>
          </select>
        </div>
        <div><label class="stat-label">Abbau-Rate Œ≤ (‚Ä∞/h)</label><input id="inBeta" type="number" class="input" step="0.01" inputmode="decimal" value="0.15"></div>
      </div>

      <h4 style="margin:14px 0 8px">Getr√§nkespezifikation</h4>
      <div class="grid-2" id="specs"></div>

      <h4 style="margin:14px 0 8px">Sicherheit & Dynamik</h4>
      <div class="grid-2">
        <div class="card">
          <div class="toggle"><input type="checkbox" id="toggleAbsorb"><label for="toggleAbsorb">Aufnahmephase aktivieren</label></div>
          <div class="hint" style="margin:6px 0 8px">Alkohol wird √ºber X Minuten verteilt freigesetzt (nur f√ºr neue Drinks).</div>
          <label class="stat-label">Dauer (Minuten)</label>
          <input id="inAbsorbMin" type="number" class="input" min="1" max="120" step="1" value="20">
        </div>
        <div class="card">
          <div class="toggle"><input type="checkbox" id="toggleLimit"><label for="toggleLimit">Maximal-Drinks Limit aktivieren</label></div>
          <div class="hint" style="margin:6px 0 8px">Zeigt ein Banner, wenn das Limit √ºberschritten wird.</div>
          <label class="stat-label">Limit (Drinks)</label>
          <input id="inLimit" type="number" class="input" min="1" step="1" value="10">
        </div>
      </div>

      <div class="muted" style="font-size:12px;margin-top:10px">Gramm = ml √ó (%Vol/100) √ó 0,789. Bei cl: ml = cl √ó 10.</div>
    </div>
  </div>

  <!-- Manuell hinzuf√ºgen / Bearbeiten -->
  <div class="bottom-sheet" id="sheetManual">
    <div class="sheet">
      <div class="row" style="margin-bottom:8px">
        <div class="drink-title" id="manualTitle">Drink hinzuf√ºgen</div>
        <div style="display:flex;gap:8px">
          <button id="btnManualCancel" class="btn">Abbrechen</button>
          <button id="btnManualSave" class="btn btn-primary">Speichern</button>
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label class="stat-label">Getr√§nk</label>
          <select id="manualType" class="input">
            <option value="shot-spirit">Shot ‚Äì Spirituose</option>
            <option value="shot-liqueur">Shot ‚Äì Lik√∂r</option>
            <option value="longdrink">Long Drink</option>
            <option value="beer">Bier</option>
            <option value="wine">Wein</option>
          </select>
        </div>
        <div>
          <label class="stat-label">Zeitpunkt</label>
          <input id="manualWhen" type="datetime-local" class="input">
        </div>
        <div>
          <label class="stat-label">Einheit</label>
          <select id="manualUnit" class="input">
            <option value="ml">ml</option>
            <option value="cl">cl</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px">
        <div>
          <label class="stat-label">Menge</label>
          <input id="manualVol" type="number" class="input" step="0.5">
        </div>
        <div>
          <label class="stat-label">% Vol.</label>
          <input id="manualAbv" type="number" class="input" step="0.5">
        </div>
      </div>
      <div class="hint" style="margin-top:8px">Beim manuellen Hinzuf√ºgen werden Presets verwendet. Danach kannst du Werte pro Eintrag anpassen.</div>
    </div>
  </div>

  <!-- Reset best√§tigen -->
  <div class="bottom-sheet" id="sheetConfirm">
    <div class="sheet">
      <div class="row" style="margin-bottom:10px">
        <div class="drink-title">Zur√ºcksetzen?</div>
        <div style="display:flex;gap:8px">
          <button id="btnConfirmCancel" class="btn">Abbrechen</button>
          <button id="btnConfirmReset" class="btn btn-primary" style="background:rgba(239,68,68,.92);border-color:rgba(239,68,68,.55);color:#1b0606">Ja, l√∂schen</button>
        </div>
      </div>
      <div class="muted" style="font-size:13px;line-height:1.4">
        M√∂chtest du wirklich <b>alle Eintr√§ge</b> l√∂schen? Dieser Schritt kann nicht r√ºckg√§ngig gemacht werden.
      </div>
    </div>
  </div>

  <!-- Snackbar f√ºr Undo -->
  <div class="snackbar" id="snack">
    <div class="bar">
      <span id="snackText">Eintrag gel√∂scht.</span>
      <button id="snackUndo" class="link">R√ºckg√§ngig</button>
    </div>
  </div>

  <script>
  'use strict';
  (function(){
    document.addEventListener('DOMContentLoaded', init);

    function init(){
      const ETHANOL_DENSITY = 0.789;

      const defaults = {
        specs:{
          shotSpirit:{unit:'cl', vol:2, abv:40, label:'Spirituosen‚ÄëShot'},
          shotLiqueur:{unit:'cl', vol:2, abv:15, label:'Lik√∂r‚ÄëShot'},
          longdrink:{unit:'cl', vol:4,  abv:40, label:'Long Drink'},
          beer:{unit:'ml', vol:500, abv:5,  label:'Bier'},
          wine:{unit:'ml', vol:200, abv:12, label:'Wein'}
        },
        weightKg:75,
        sex:'m',
        beta:0.15,
        absorbEnabled:false,
        absorbMinutes:20,
        limitEnabled:false,
        limitNumber:10,
        shotQuickKind:'spirit',
        events:[]
      };

      const store = {
        get(){ try { return JSON.parse(localStorage.getItem('dt_state')||'{}'); } catch(_e){ return {}; } },
        set(o){ localStorage.setItem('dt_state', JSON.stringify(o)); }
      };

      const state = Object.assign({}, defaults, store.get());
      state.specs = Object.assign({}, defaults.specs, state.specs||{});
      if(!Array.isArray(state.events)) state.events = [];
      if(!['spirit','liqueur'].includes(state.shotQuickKind)) state.shotQuickKind = 'spirit';

      // --- Helpers ---
      function makeId(seed){
        const base = Number.isFinite(seed) ? seed : Date.now();
        return 'evt_'+base+'_'+Math.random().toString(36).slice(2,7);
      }
      function save(){ store.set(state); }

      function pulse(node){
        if(!node) return;
        node.classList.remove('pulse');
        void node.offsetWidth;
        node.classList.add('pulse');
        setTimeout(()=>node.classList.remove('pulse'), 650);
      }

      function openSheet(overlay){
        if(!overlay) return;
        overlay.classList.remove('closing');
        overlay.style.display = 'flex';
      }

      function closeSheet(overlay){
        if(!overlay) return;
        overlay.classList.add('closing');
        setTimeout(()=>{
          overlay.classList.remove('closing');
          overlay.style.display = 'none';
        }, 190);
      }

      function gramsForSpec(unit, vol, abv){
        const ml = unit==='cl' ? (vol*10) : vol;
        return ml * (abv/100) * ETHANOL_DENSITY;
      }
      function gramsForSpecKey(specKey){
        const s = state.specs[specKey];
        return gramsForSpec(s.unit, s.vol, s.abv);
      }
      function fmtDur(h){
        if(!isFinite(h)) return '‚Äì';
        const m = Math.max(0, Math.round(h*60));
        return `${Math.floor(m/60)}h ${m%60}m`;
      }
      function fmtTimeFromNow(h){
        if(!isFinite(h)) return '‚Äì';
        const t = new Date(Date.now() + Math.max(0, Math.round(h*60))*60000);
        return t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      }
      function toLocalDatetimeValue(ms){
        const d = new Date(ms);
        return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
      }
      function parseLocalDatetimeValue(dtStr){
        try{
          const [dPart,tPart] = String(dtStr||'').split('T');
          const [y,m,da] = dPart.split('-').map(n=>parseInt(n,10));
          const [hh,mm] = (tPart||'00:00').split(':').map(n=>parseInt(n,10));
          const local = new Date(y,(m-1),da,hh,mm,0,0);
          return local.getTime();
        } catch(_e){
          const t = Date.parse(dtStr);
          return isNaN(t) ? Date.now() : t;
        }
      }

      // --- Migration / Normalize existing events ---
      state.events.forEach(e => {
        if(!e.id) e.id = makeId(e.time);
        if(e.type==='shot' && !e.shotKind) e.shotKind='spirit';
        if(e.type==='shotSpirit'){ e.type='shot'; e.shotKind='spirit'; }
        if(e.type==='shotLiqueur'){ e.type='shot'; e.shotKind='liqueur'; }
        if(!e.unit){
          let s = null;
          if(e.type==='shot') s = (e.shotKind==='liqueur') ? state.specs.shotLiqueur : state.specs.shotSpirit;
          else s = state.specs[e.type] || {unit:'ml', vol:0, abv:0};
          e.unit=s.unit; e.vol=s.vol; e.abv=s.abv;
        }
        if(typeof e.absorbEnabled !== 'boolean') e.absorbEnabled = !!state.absorbEnabled;
        if(!Number.isFinite(e.absorbMinutes)) e.absorbMinutes = Math.max(1, parseInt(state.absorbMinutes)||20);
        if(!Number.isFinite(e.grams)) e.grams = gramsForSpec(e.unit, e.vol, e.abv);
      });
      save();

      const el = {
        controls: document.getElementById('controls'),
        log: document.getElementById('log'),
        logEmpty: document.getElementById('log-empty'),
        statBac: document.getElementById('stat-bac'),
        statZero: document.getElementById('stat-zero'),
        statGrams: document.getElementById('stat-grams'),
        statStart: document.getElementById('stat-start'),
        statLast: document.getElementById('stat-last'),
        gramsCard: document.getElementById('stat-grams-card'),
        flow: document.getElementById('flow'),
        // Banner
        banner: document.getElementById('limitBanner'),
        bannerClose: document.getElementById('closeBanner'),
        // Settings
        sheet: document.getElementById('sheet'),
        btnSettings: document.getElementById('btnSettings'),
        btnClose: document.getElementById('btnClose'),
        btnDefaults: document.getElementById('btnDefaults'),
        btnReset: document.getElementById('btnReset'),
        inWeight: document.getElementById('inWeight'),
        inSex: document.getElementById('inSex'),
        inBeta: document.getElementById('inBeta'),
        tAbs: document.getElementById('toggleAbsorb'),
        vAbs: document.getElementById('inAbsorbMin'),
        tLimit: document.getElementById('toggleLimit'),
        vLimit: document.getElementById('inLimit'),
        // Manual
        btnAddManual: document.getElementById('btnAddManual'),
        sheetManual: document.getElementById('sheetManual'),
        manualTitle: document.getElementById('manualTitle'),
        manualType: document.getElementById('manualType'),
        manualWhen: document.getElementById('manualWhen'),
        manualUnit: document.getElementById('manualUnit'),
        manualVol: document.getElementById('manualVol'),
        manualAbv: document.getElementById('manualAbv'),
        manualSave: document.getElementById('btnManualSave'),
        manualCancel: document.getElementById('btnManualCancel'),
        // Export
        btnExport: document.getElementById('btnExport'),
        // Snackbar
        snack: document.getElementById('snack'),
        snackText: document.getElementById('snackText'),
        snackUndo: document.getElementById('snackUndo'),
        // Reset confirm
        sheetConfirm: document.getElementById('sheetConfirm'),
        btnConfirmCancel: document.getElementById('btnConfirmCancel'),
        btnConfirmReset: document.getElementById('btnConfirmReset')
      };

      // --- Core BAC ---
      function releasedGramsAt(t){
        if(state.events.length===0) return 0;
        let sum = 0;
        for(const e of state.events){
          const enabled = !!e.absorbEnabled;
          const X = Math.max(1, (Number.isFinite(e.absorbMinutes) ? e.absorbMinutes : 20));
          if(!enabled){
            if(t >= e.time) sum += e.grams;
          } else {
            const dt = (t - e.time) / 60000;
            const f = Math.max(0, Math.min(1, dt / X));
            sum += e.grams * f;
          }
        }
        return sum;
      }

      function computeBAC(){
        const r = state.sex==='m' ? 0.68 : 0.55;
        const now = Date.now();
        if(state.events.length===0) return {bac:0,hoursToZero:0,totalGrams:0,first:null,last:null};

        const released = releasedGramsAt(now);
        const firstMs = Math.min(...state.events.map(e=>e.time));
        const lastMs  = Math.max(...state.events.map(e=>e.time));
        const first = new Date(firstMs);
        const hours = Math.max(0, (now - firstMs)/3600000);

        let bac = (released/(r*state.weightKg)) - state.beta*hours;
        bac = Math.max(0, bac);
        const hoursToZero = bac<=0 ? 0 : bac/state.beta;
        const totalGrams = state.events.reduce((s,e)=>s+e.grams,0);
        return {bac,hoursToZero,totalGrams,first,last:new Date(lastMs)};
      }

      function bacAt(t){
        const r = state.sex==='m' ? 0.68 : 0.55;
        if(state.events.length===0) return 0;
        const firstMs = Math.min(...state.events.map(e=>e.time));
        const released = releasedGramsAt(t);
        const hours = Math.max(0, (t - firstMs)/3600000);
        let bac = (released/(r*state.weightKg)) - state.beta*hours;
        return Math.max(0, bac);
      }

      function computePeakBAC(){
        if(state.events.length===0) return {peak:0, peakTime:null};

        const candidates = new Set();
        const globalAbs = Math.max(1, parseInt(state.absorbMinutes)||20);

        for(const e of state.events){
          candidates.add(e.time);
          if(e.absorbEnabled){
            const X = Math.max(1, Number.isFinite(e.absorbMinutes) ? e.absorbMinutes : globalAbs);
            candidates.add(e.time + X*60000);
          }
        }
        const lastMs = Math.max(...state.events.map(e=>e.time));
        candidates.add(lastMs);
        candidates.add(lastMs + globalAbs*60000);

        let best = 0;
        let bestT = null;
        for(const t of candidates){
          const b = bacAt(t);
          if(b > best + 1e-9){
            best = b;
            bestT = t;
          }
        }
        return {peak: best, peakTime: bestT ? new Date(bestT) : null};
      }

      // --- UI Rendering ---
      function renderControls(){
        el.controls.innerHTML='';

        const shotCount = state.events.filter(e=>e.type==='shot').length;
        const gSpirit = gramsForSpecKey('shotSpirit');
        const gLiq = gramsForSpecKey('shotLiqueur');
        const isSpirit = (state.shotQuickKind||'spirit')==='spirit';

        const shotCard = document.createElement('div');
        shotCard.className='card';
        shotCard.innerHTML = `
          <div>
            <div class="row" style="margin-top:0">
              <div>
                <div class="drink-title">Shot</div>
                <div class="drink-sub">ü•É ${state.specs.shotSpirit.vol} cl @ ${state.specs.shotSpirit.abv}% ‚âà ${gSpirit.toFixed(1)} g ‚Ä¢ üç¨ ${state.specs.shotLiqueur.vol} cl @ ${state.specs.shotLiqueur.abv}% ‚âà ${gLiq.toFixed(1)} g</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
                <span class="muted" style="font-size:12px">Modus:</span>
                <button class="btn ${isSpirit?'btn-primary':''}" data-setshot="spirit" style="padding:6px 10px;border-radius:12px">ü•É Spirit</button>
                <button class="btn ${!isSpirit?'btn-primary':''}" data-setshot="liqueur" style="padding:6px 10px;border-radius:12px">üç¨ Lik√∂r</button>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="counter" id="count-shot">${shotCount}</div>
            <div style="display:flex;gap:8px">
              <button class="btn" data-minus="shot">-</button>
              <button class="btn btn-primary" data-plus="shot">+</button>
            </div>
          </div>`;
        el.controls.appendChild(shotCard);

        ['longdrink','beer','wine'].forEach(type=>{
          const count = state.events.filter(e=>e.type===type).length;
          const spec = state.specs[type];
          const g = gramsForSpecKey(type);
          const sub = spec.unit==='cl'
            ? `${spec.vol} cl @ ${spec.abv}% ‚âà ${g.toFixed(1)} g`
            : `${spec.vol} ml @ ${spec.abv}% ‚âà ${g.toFixed(1)} g`;

          const card = document.createElement('div');
          card.className='card';
          card.innerHTML = `
            <div>
              <div class="drink-title">${spec.label}</div>
              <div class="drink-sub">${sub}</div>
            </div>
            <div class="row">
              <div class="counter" id="count-${type}">${count}</div>
              <div style="display:flex;gap:8px">
                <button class="btn" data-minus="${type}">-</button>
                <button class="btn btn-primary" data-plus="${type}">+</button>
              </div>
            </div>`;
          el.controls.appendChild(card);
        });
      }

      function renderStats(highlight){
        const r = computeBAC();
        const p = computePeakBAC();

        el.statBac.textContent = r.bac.toFixed(2)+' ‚Ä∞';
        el.statZero.textContent = fmtDur(r.hoursToZero) + (r.hoursToZero>0?` (~${fmtTimeFromNow(r.hoursToZero)} Uhr)`:'');
        el.statGrams.textContent = Math.round(r.totalGrams)+' g';
        el.statStart.textContent = r.first ? r.first.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '‚Äì';

        const peakText = p.peakTime
          ? `Peak: ${p.peak.toFixed(2)} ‚Ä∞ um ${p.peakTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
          : 'Peak: ‚Äì';

        if(r.last){
          const mins = Math.max(0, Math.round((Date.now() - r.last.getTime())/60000));
          el.statLast.textContent = `${peakText} ¬∑ Letzter Drink: vor ${mins} min`;
        } else {
          el.statLast.textContent = peakText;
        }

        el.gramsCard.style.boxShadow = highlight ? '0 0 0 2px rgba(239,68,68,.5) inset' : 'none';
      }

      function renderLog(){
        el.log.innerHTML='';
        if(state.events.length===0){ el.logEmpty.style.display='block'; return; }
        el.logEmpty.style.display='none';

        state.events.slice().sort((a,b)=>b.time-a.time).forEach(e => {
          const specText = e.unit==='cl' ? `${e.vol} cl @ ${e.abv}%` : `${e.vol} ml @ ${e.abv}%`;
          const absTag = e.absorbEnabled ? `Abs: ${Math.round(e.absorbMinutes||0)}m` : `Abs: aus`;
          const shotTag = e.type==='shot' ? (e.shotKind==='liqueur' ? 'Lik√∂r' : 'Spirit') : '';

          const li = document.createElement('li');
          li.innerHTML = `
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <span class="pill" style="color:#e5e7eb;text-transform:capitalize">${e.type}${shotTag?` (${shotTag})`:''}</span>
              <span class="muted">${new Date(e.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
              <span class="muted">‚Ä¢ ${specText} ‚Ä¢ ${absTag}</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
              <span>${e.grams.toFixed(1)} g</span>
              <button class="btn" data-edit="${e.id}" aria-label="Eintrag bearbeiten">‚úèÔ∏è</button>
              <button class="btn" data-del="${e.id}" aria-label="Eintrag l√∂schen">üóëÔ∏è</button>
            </div>`;
          el.log.appendChild(li);
        });
      }

      function renderFlow(){
        const svg = el.flow;
        svg.innerHTML='';
        const width=640, height=260, pad=18, axisX=60;

        if(state.events.length===0){
          const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
          txt.setAttribute('x',10); txt.setAttribute('y',20); txt.setAttribute('fill','#9ca3af');
          txt.textContent='Noch keine Daten. F√ºge Getr√§nke hinzu, um den Verlauf zu sehen.';
          svg.appendChild(txt);
          return;
        }

        const data = state.events.slice().sort((a,b)=>a.time-b.time);
        const t0 = data[0].time;
        const t1 = data[data.length-1].time;
        const span = Math.max(1, t1-t0);

        let cum=0;
        const pts = data.map(d=>{
          cum++;
          const y = pad + ((d.time-t0)/span)*(height-2*pad);
          const x = axisX + (cum/Math.max(1,data.length))*(width-axisX-pad);
          return {x,y,...d};
        });

        const axis=document.createElementNS('http://www.w3.org/2000/svg','line');
        axis.setAttribute('x1',axisX); axis.setAttribute('y1',pad);
        axis.setAttribute('x2',axisX); axis.setAttribute('y2',height-pad);
        axis.setAttribute('stroke','#334155'); axis.setAttribute('stroke-width','2');
        svg.appendChild(axis);

        const pl=document.createElementNS('http://www.w3.org/2000/svg','polyline');
        pl.setAttribute('fill','none');
        pl.setAttribute('stroke','var(--line)');
        pl.setAttribute('stroke-width','2');
        pl.setAttribute('points', pts.map(p=>p.x+','+p.y).join(' '));
        svg.appendChild(pl);

        pts.forEach(p=>{
          const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
          c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',5);
          const col = p.type==='shot'?'var(--shot)':p.type==='longdrink'?'var(--long)':p.type==='beer'?'var(--beer)':'var(--wine)';
          c.setAttribute('fill',col);
          svg.appendChild(c);
        });
      }

      function updateUI(){
        renderControls();
        renderStats(false);
        renderLog();
        renderFlow();
      }

      // --- Export (√∂ffnet Print Dialog) ---
      function exportSessionPDF(){
        const r = computeBAC();
        const peak = computePeakBAC();
        const events = state.events.slice().sort((a,b)=>a.time-b.time);
        const start = r.first ? r.first.toLocaleString() : '‚Äì';
        const end = r.last ? r.last.toLocaleString() : '‚Äì';
        const nowStr = new Date().toLocaleString();

        const shotSpiritCount = state.events.filter(e=>e.type==='shot' && (e.shotKind||'spirit')==='spirit').length;
        const shotLiqCount    = state.events.filter(e=>e.type==='shot' && (e.shotKind||'spirit')==='liqueur').length;
        const longCount = state.events.filter(e=>e.type==='longdrink').length;
        const beerCount = state.events.filter(e=>e.type==='beer').length;
        const wineCount = state.events.filter(e=>e.type==='wine').length;

        const rows = events.map(e=>{
          const time = new Date(e.time).toLocaleString();
          const type = e.type==='shot' ? `Shot (${(e.shotKind==='liqueur')?'Lik√∂r':'Spirit'})` : (e.type==='longdrink'?'Long Drink':e.type==='beer'?'Bier':'Wein');
          const spec = e.unit==='cl' ? `${e.vol} cl @ ${e.abv}%` : `${e.vol} ml @ ${e.abv}%`;
          const abs  = e.absorbEnabled ? `An (${Math.round(e.absorbMinutes||0)} min)` : 'Aus';
          return `<tr><td>${time}</td><td>${type}</td><td>${spec}</td><td style="text-align:right">${e.grams.toFixed(1)}</td><td>${abs}</td></tr>`;
        }).join('');

        const peakLine = peak.peakTime
          ? `${peak.peak.toFixed(2)} ‚Ä∞ (um ${peak.peakTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})})`
          : '‚Äì';

        const html = `<!doctype html>
<html lang="de"><head><meta charset="utf-8"/>
<title>Drink-Tracker Export</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111}
  h1{margin:0 0 6px 0;font-size:22px}
  .muted{color:#555}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin:14px 0}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px}
  .label{font-size:12px;color:#666}
  .value{font-size:18px;font-weight:600;margin-top:2px}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:12px}
  th,td{border-top:1px solid #ddd;padding:8px;vertical-align:top}
  th{text-align:left;background:#f6f6f6}
  .right{text-align:right}
  @media print{ body{margin:12mm} }
</style></head>
<body>
  <h1>Drink-Tracker Export</h1>
  <div class="muted">Erstellt am ${nowStr} ‚Ä¢ Zeitraum: ${start} ‚Äì ${end}</div>

  <div class="grid">
    <div class="card"><div class="label">H√∂chstwert (Peak)</div><div class="value">${peakLine}</div><div class="muted">Hinweis: Sch√§tzung</div></div>
    <div class="card"><div class="label">Aktueller BAC (jetzt)</div><div class="value">${r.bac.toFixed(2)} ‚Ä∞</div><div class="muted">zum Exportzeitpunkt</div></div>
    <div class="card"><div class="label">Zeit bis ~0‚Ä∞ (jetzt)</div><div class="value">${fmtDur(r.hoursToZero)}</div><div class="muted">~${fmtTimeFromNow(r.hoursToZero)} Uhr</div></div>
    <div class="card"><div class="label">Gesamt Alkohol</div><div class="value">${Math.round(r.totalGrams)} g</div><div class="muted">Dichte 0,789 g/ml</div></div>
    <div class="card"><div class="label">Profil</div><div class="value">${state.weightKg} kg ‚Ä¢ ${state.sex==='m'?'m√§nnlich':'weiblich'}</div><div class="muted">Œ≤=${state.beta} ‚Ä∞/h</div></div>
  </div>

  <div class="card">
    <div class="label">Zusammenfassung (Anzahl)</div>
    <div class="value" style="font-size:16px">Shots: ${shotSpiritCount+shotLiqCount} (Spirit ${shotSpiritCount}, Lik√∂r ${shotLiqCount}) ‚Ä¢ Long Drinks: ${longCount} ‚Ä¢ Bier: ${beerCount} ‚Ä¢ Wein: ${wineCount}</div>
    <div class="muted" style="font-size:12px;margin-top:6px">Aufnahmephase (Default): ${state.absorbEnabled?'aktiv':'aus'} (${state.absorbMinutes} min) ‚Ä¢ Limit: ${state.limitEnabled?'aktiv':'aus'} (${state.limitNumber})</div>
  </div>

  <h2 style="margin:16px 0 6px 0;font-size:16px">Verlauf</h2>
  <table>
    <thead><tr><th>Zeit</th><th>Typ</th><th>Spezifikation</th><th class="right">g</th><th>Aufnahmephase</th></tr></thead>
    <tbody>${rows || '<tr><td colspan="5" class="muted">Keine Eintr√§ge</td></tr>'}</tbody>
  </table>

  <p class="muted" style="margin-top:14px;font-size:11px">Wichtiger Hinweis: Diese Auswertung ist ein grober Sch√§tzwert und ersetzt keine rechtliche/medizinische Beurteilung. Nicht zum Entscheiden √ºber Fahrt√ºchtigkeit verwenden.</p>
</body></html>`;

        const w = window.open('', '_blank');
        if(!w){
          alert('Pop-up blockiert. Bitte Pop-ups f√ºr diese Seite erlauben oder verwende den Browser-Teilen/Drucken-Dialog.');
          return;
        }
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.focus();
        setTimeout(()=>{ w.print(); }, 300);
      }

      function maybeShowLimitBanner(lastType){
        if(!state.limitEnabled) return;
        if(state.events.length <= state.limitNumber) return;
        document.getElementById('limitVal').textContent = state.limitNumber;
        el.banner.classList.add('show');
        const c=document.getElementById('count-'+lastType);
        if(c){ c.classList.add('shake'); setTimeout(()=>c.classList.remove('shake'),800); }
        renderStats(true);
        setTimeout(()=>renderStats(false), 10000);
      }

      // Snackbar (Undo Delete)
      let lastDeleted = null;
      let snackTimer = null;
      function showSnack(text){
        el.snackText.textContent = text;
        el.snack.classList.add('show');
        clearTimeout(snackTimer);
        snackTimer = setTimeout(hideSnack, 8000);
      }
      function hideSnack(){ el.snack.classList.remove('show'); }

      el.snackUndo.addEventListener('click', ()=>{
        if(!lastDeleted) return;
        state.events.push(lastDeleted);
        lastDeleted = null;
        save();
        updateUI();
        hideSnack();
      });

      // --- Manual add/edit ---
      let manualEditId = null;
      let manualTouched = { unit:false, vol:false, abv:false };

      function specForManualType(val){
        if(val==='shot-spirit') return {type:'shot', shotKind:'spirit', preset: state.specs.shotSpirit};
        if(val==='shot-liqueur') return {type:'shot', shotKind:'liqueur', preset: state.specs.shotLiqueur};
        if(val==='longdrink') return {type:'longdrink', shotKind:null, preset: state.specs.longdrink};
        if(val==='beer') return {type:'beer', shotKind:null, preset: state.specs.beer};
        return {type:'wine', shotKind:null, preset: state.specs.wine};
      }

      function applyPresetToManual(val){
        const info = specForManualType(val);
        el.manualUnit.value = info.preset.unit;
        el.manualVol.value = info.preset.vol;
        el.manualAbv.value = info.preset.abv;
      }

      function openManualAdd(){
        manualEditId = null;
        manualTouched = { unit:false, vol:false, abv:false };
        el.manualTitle.textContent = 'Drink hinzuf√ºgen';
        // Default: use shot mode for shot, otherwise first option.
        el.manualType.value = (state.shotQuickKind==='liqueur') ? 'shot-liqueur' : 'shot-spirit';
        applyPresetToManual(el.manualType.value);
        el.manualWhen.value = toLocalDatetimeValue(Date.now());
        openSheet(el.sheetManual);
      }

      function openManualEdit(evtObj){
        manualEditId = evtObj.id;
        manualTouched = { unit:true, vol:true, abv:true };
        el.manualTitle.textContent = 'Eintrag bearbeiten';
        const typeVal = evtObj.type==='shot'
          ? (evtObj.shotKind==='liqueur' ? 'shot-liqueur' : 'shot-spirit')
          : evtObj.type;
        el.manualType.value = typeVal;
        el.manualWhen.value = toLocalDatetimeValue(evtObj.time);
        el.manualUnit.value = evtObj.unit;
        el.manualVol.value = evtObj.vol;
        el.manualAbv.value = evtObj.abv;
        openSheet(el.sheetManual);
      }

      el.btnAddManual.addEventListener('click', openManualAdd);
      el.manualCancel.addEventListener('click', ()=>closeSheet(el.sheetManual));
      el.sheetManual.addEventListener('click', (e)=>{ if(e.target===el.sheetManual) closeSheet(el.sheetManual); });

      el.manualType.addEventListener('change', ()=>{
        // When switching type, apply that preset (user can still override)
        manualTouched = { unit:false, vol:false, abv:false };
        applyPresetToManual(el.manualType.value);
      });
      el.manualUnit.addEventListener('input', ()=>{ manualTouched.unit=true; });
      el.manualVol.addEventListener('input', ()=>{ manualTouched.vol=true; });
      el.manualAbv.addEventListener('input', ()=>{ manualTouched.abv=true; });

      el.manualSave.addEventListener('click', ()=>{
        const info = specForManualType(el.manualType.value);
        const time = parseLocalDatetimeValue(el.manualWhen.value);
        const unit = el.manualUnit.value;
        const vol  = Math.max(0, parseFloat(el.manualVol.value)||0);
        const abv  = Math.max(0, parseFloat(el.manualAbv.value)||0);
        const grams = gramsForSpec(unit, vol, abv);

        if(manualEditId){
          const idx = state.events.findIndex(e=>e.id===manualEditId);
          if(idx>=0){
            const prev = state.events[idx];
            state.events[idx] = Object.assign({}, prev, {
              type: info.type,
              shotKind: info.type==='shot' ? info.shotKind : undefined,
              time,
              unit, vol, abv, grams
            });
          }
        } else {
          state.events.push({
            id: makeId(time),
            type: info.type,
            shotKind: info.type==='shot' ? info.shotKind : undefined,
            time,
            unit, vol, abv,
            grams,
            absorbEnabled: !!state.absorbEnabled,
            absorbMinutes: Math.max(1, parseInt(state.absorbMinutes)||20)
          });
          maybeShowLimitBanner(info.type==='shot' ? 'shot' : info.type);
        }

        save();
        updateUI();
        closeSheet(el.sheetManual);
        pulse(document.getElementById('card-bac'));
      });

      // Quick shot add
      function addShot(kind){
        const presetKey = (kind==='liqueur') ? 'shotLiqueur' : 'shotSpirit';
        const preset = state.specs[presetKey];
        const grams = gramsForSpec(preset.unit, preset.vol, preset.abv);
        state.events.push({
          id: makeId(Date.now()),
          type:'shot',
          shotKind: kind,
          time: Date.now(),
          unit: preset.unit,
          vol: preset.vol,
          abv: preset.abv,
          grams,
          absorbEnabled: !!state.absorbEnabled,
          absorbMinutes: Math.max(1, parseInt(state.absorbMinutes)||20)
        });
        save();
        maybeShowLimitBanner('shot');
        updateUI();
        pulse(document.getElementById('card-bac'));
        pulse(document.getElementById('count-shot'));
      }

      // Controls: Plus/Minus
      el.controls.addEventListener('click', (evt)=>{
        const t = evt.target;

        const setShot = t.getAttribute('data-setshot');
        if(setShot){
          state.shotQuickKind = (setShot==='liqueur') ? 'liqueur' : 'spirit';
          save();
          renderControls();
          return;
        }

        const plus = t.getAttribute('data-plus');
        const minus = t.getAttribute('data-minus');

        if(plus){
          if(plus==='shot'){
            addShot(state.shotQuickKind||'spirit');
            return;
          }
          const s = state.specs[plus];
          const grams = gramsForSpec(s.unit, s.vol, s.abv);
          state.events.push({
            id: makeId(Date.now()),
            type: plus,
            time: Date.now(),
            unit: s.unit,
            vol: s.vol,
            abv: s.abv,
            grams,
            absorbEnabled: !!state.absorbEnabled,
            absorbMinutes: Math.max(1, parseInt(state.absorbMinutes)||20)
          });
          save();
          maybeShowLimitBanner(plus);
          updateUI();
          pulse(document.getElementById('card-bac'));
          pulse(document.getElementById('count-'+plus));
          return;
        }

        if(minus){
          for(let i=state.events.length-1;i>=0;i--){
            if(state.events[i].type===minus){ state.events.splice(i,1); break; }
          }
          save();
          updateUI();
        }
      });

      // Log edit/delete
      el.log.addEventListener('click', (evt)=>{
        const t = evt.target;
        const editId = t.getAttribute('data-edit');
        const delId = t.getAttribute('data-del');
        if(editId){
          const obj = state.events.find(e=>e.id===editId);
          if(obj) openManualEdit(obj);
          return;
        }
        if(delId){
          const idx = state.events.findIndex(e=>e.id===delId);
          if(idx>=0){
            lastDeleted = state.events[idx];
            state.events.splice(idx,1);
            save();
            updateUI();
            showSnack('Eintrag gel√∂scht.');
          }
        }
      });

      // Settings
      el.btnSettings.addEventListener('click', ()=>{
        openSheet(el.sheet);
        renderSpecs();
        fillSettings();
      });
      el.btnClose.addEventListener('click', ()=>{ closeSheet(el.sheet); pulse(document.getElementById('card-bac')); });
      el.sheet.addEventListener('click', (e)=>{ if(e.target===el.sheet) closeSheet(el.sheet); });

      function fillSettings(){
        el.inWeight.value = state.weightKg;
        el.inSex.value = state.sex;
        el.inBeta.value = state.beta;
        el.tAbs.checked = state.absorbEnabled;
        el.vAbs.value = state.absorbMinutes;
        el.tLimit.checked = state.limitEnabled;
        el.vLimit.value = state.limitNumber;
      }

      function renderSpecs(){
        const box = document.getElementById('specs');
        box.innerHTML='';

        const add=(key,label,unit)=>{
          const d=document.createElement('div');
          d.className='card';
          d.innerHTML=`
            <div class="drink-sub" style="margin-bottom:6px;color:#d1d5db">${label}</div>
            <label class="stat-label">Menge (${unit})</label>
            <input id="vol-${key}" type="number" class="input" step="${unit==='cl'?'0.5':'5'}" value="${state.specs[key].vol}">
            <label class="stat-label" style="margin-top:6px;display:block">Alkoholgehalt (% Vol.)</label>
            <input id="abv-${key}" type="number" class="input" step="0.5" value="${state.specs[key].abv}">
            <div class="muted" style="font-size:11px;margin-top:6px">‚âà <span id="g-${key}"></span> g reiner Alkohol</div>
          `;
          box.appendChild(d);
        };

        add('shotSpirit','Shot ‚Äì Spirituose','cl');
        add('shotLiqueur','Shot ‚Äì Lik√∂r','cl');
        add('longdrink','Long Drink','cl');
        add('beer','Bier','ml');
        add('wine','Wein','ml');

        ['shotSpirit','shotLiqueur','longdrink','beer','wine'].forEach(k=>{
          const vol=document.getElementById('vol-'+k);
          const abv=document.getElementById('abv-'+k);
          const g=document.getElementById('g-'+k);
          const upd=()=>{
            state.specs[k].vol = parseFloat(vol.value)||0;
            state.specs[k].abv = parseFloat(abv.value)||0;
            g.textContent = gramsForSpecKey(k).toFixed(1);
            save();
            renderControls();
          };
          vol.addEventListener('input', upd);
          abv.addEventListener('input', upd);
          upd();
        });

        el.inWeight.oninput = ()=>{ state.weightKg=parseFloat(el.inWeight.value)||0; save(); updateUI(); };
        el.inSex.onchange = ()=>{ state.sex=el.inSex.value; save(); updateUI(); };
        el.inBeta.oninput = ()=>{ state.beta=parseFloat(el.inBeta.value)||0; save(); updateUI(); };
        el.tAbs.onchange = ()=>{ state.absorbEnabled=el.tAbs.checked; save(); updateUI(); };
        el.vAbs.oninput = ()=>{ state.absorbMinutes=Math.max(1, parseInt(el.vAbs.value)||20); save(); updateUI(); };
        el.tLimit.onchange = ()=>{ state.limitEnabled=el.tLimit.checked; save(); updateUI(); };
        el.vLimit.oninput = ()=>{ state.limitNumber=Math.max(1, parseInt(el.vLimit.value)||10); save(); updateUI(); };
      }

      // Standardwerte: nur Einstellungen/Specs zur√ºcksetzen (Verlauf behalten!)
      el.btnDefaults.addEventListener('click', ()=>{
        const keepEvents = state.events;
        const keepShotMode = state.shotQuickKind;
        Object.assign(state, JSON.parse(JSON.stringify(defaults)));
        state.specs = Object.assign({}, defaults.specs);
        state.events = keepEvents;
        state.shotQuickKind = keepShotMode || 'spirit';
        save();
        renderSpecs();
        fillSettings();
        updateUI();
      });

      // Export
      el.btnExport.addEventListener('click', exportSessionPDF);

      // Reset: confirm sheet (reliable)
      el.btnReset.addEventListener('click', ()=>{ openSheet(el.sheetConfirm); });
      el.btnConfirmCancel.addEventListener('click', ()=>closeSheet(el.sheetConfirm));
      el.sheetConfirm.addEventListener('click', (e)=>{ if(e.target===el.sheetConfirm) closeSheet(el.sheetConfirm); });
      el.btnConfirmReset.addEventListener('click', ()=>{
        state.events = [];
        save();
        updateUI();
        closeSheet(el.sheetConfirm);
      });

      // Banner close
      el.bannerClose.addEventListener('click', ()=>{ el.banner.classList.remove('show'); });

      // Auto refresh stats
      setInterval(()=>renderStats(false), 30000);

      // --- Minimal self-tests (console) ---
      (function runTests(){
        try{
          const g = gramsForSpec('cl', 2, 40); // 20ml *0.4*0.789 = 6.312
          console.assert(Math.abs(g - 6.312) < 0.05, 'Test gramsForSpec failed', g);
          // Peak should be >= current bac at same moment
          const now = Date.now();
          const cur = bacAt(now);
          const pk = computePeakBAC().peak;
          console.assert(pk + 1e-9 >= cur, 'Test peak>=current failed', {pk,cur});
        } catch(e){
          console.warn('Tests skipped/failed', e);
        }
      })();

      updateUI();
    }
  })();
  </script>
</body>
</html>
