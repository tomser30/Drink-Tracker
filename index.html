<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drink-Tracker · BAC</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a0f1c; --card:#0f172a; --border:#1f2937;
      --txt:#e5e7eb; --muted:#9ca3af; --accent:#10b981; --warn:#7f1d1d; --line:#22d3ee;
      --shot:#a78bfa; --long:#34d399; --beer:#fbbf24; --wine:#60a5fa;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--txt);background:radial-gradient(1200px 800px at 20% -10%,var(--bg1),var(--bg2)),var(--bg2)}
    .container{max-width:960px;margin:0 auto;padding:12px 16px 56px}
    header{display:flex;align-items:center;justify-content:space-between;margin:12px 0 16px}
    h1{font-size:24px;margin:0;font-weight:600}
    .btn{background:var(--card);border:1px solid var(--border);color:var(--txt);padding:8px 12px;border-radius:14px;cursor:pointer}
    .btn:hover{background:#141c2a}
    .btn-primary{background:var(--accent);border-color:#0f5132}
    .grid{display:grid;gap:12px}
    .stats{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:768px){ .stats{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .card{background:rgba(15,23,42,.6);border:1px solid var(--border);border-radius:16px;padding:12px}
    .stat-label{font-size:12px;color:var(--muted)}
    .stat-value{font-size:20px;font-weight:600;margin-top:2px}
    .drinks{grid-template-columns:1fr}
    @media(min-width:768px){ .drinks{grid-template-columns:1fr 1fr} }
    .drink-title{font-size:18px;font-weight:600;margin:0}
    .drink-sub{font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    .counter{font-size:28px;font-weight:700}
    .pill{padding:4px 8px;border-radius:999px;background:#111827;border:1px solid var(--border)}
    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-top:1px solid var(--border)}
    .list li:first-child{border-top:0}
    .muted{color:var(--muted)}
    .bottom-sheet{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
    .sheet{background:var(--card);border:1px solid var(--border);border-radius:16px 16px 0 0;max-height:90vh;overflow:auto;width:100%;max-width:720px;padding:16px}
    .input{width:100%;background:#0b1324;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--txt)}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .legend{display:flex;flex-wrap:wrap;gap:8px;font-size:11px;margin-top:8px;color:#d1d5db}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    svg{display:block;width:100%}
    .banner{display:none;align-items:center;justify-content:space-between;background:var(--warn);padding:10px 14px;border-radius:12px;margin-bottom:12px}
    .banner.show{display:flex}
    .shake{animation:shake .6s}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
    .toggle{display:flex;align-items:center;gap:8px}
    .toggle input{width:18px;height:18px}
    .hint{font-size:12px;color:#9ca3af}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Drink-Tracker · BAC</h1>
      <div>
        <button id="btnSettings" class="btn">Einstellungen</button>
        <button id="btnReset" class="btn" style="background:#2b1430;border-color:#5b1b2f">Zurücksetzen</button>
      </div>
    </header>

    <div id="limitBanner" class="banner">
      <div>⚠️ Du hast dein Limit von <span id="limitVal">0</span> Drinks überschritten.</div>
      <button id="closeBanner" class="btn">Okay</button>
    </div>

    <section class="grid stats" id="stats">
      <div class="card"><div class="stat-label">Aktuell</div><div class="stat-value" id="stat-bac">0.00 ‰</div></div>
      <div class="card"><div class="stat-label">Bis ~0‰</div><div class="stat-value" id="stat-zero">–</div></div>
      <div class="card" id="stat-grams-card"><div class="stat-label">Alkohol</div><div class="stat-value" id="stat-grams">0 g</div></div>
      <div class="card"><div class="stat-label">Start</div><div class="stat-value" id="stat-start">–</div></div>
    </section>

    <section class="grid drinks" id="controls"></section>

    <section class="card" style="margin-top:16px">
      <div class="row"><div class="drink-title">Verlauf</div><div class="muted" style="font-size:12px">(neueste oben)</div></div>
      <ul class="list" id="log"></ul>
      <div class="muted" id="log-empty">Noch keine Getränke erfasst.</div>
    </section>

    <p class="muted" style="font-size:12px;margin-top:12px">Hinweis: Grober Schätzer. Verlasse dich niemals ausschließlich darauf, um über Fahren zu entscheiden.</p>

    <section class="card" style="margin-top:16px">
      <div class="row"><div class="drink-title">Flussdiagramm</div><div class="muted" style="font-size:12px">(Zeit → unten)</div></div>
      <div style="overflow-x:auto;margin-top:8px">
        <div style="min-width:320px">
          <svg id="flow" viewBox="0 0 640 260" height="220"></svg>
        </div>
      </div>
      <div class="legend">
        <span><span class="dot" style="background:var(--shot)"></span>Shot</span>
        <span><span class="dot" style="background:var(--long)"></span>Long Drink</span>
        <span><span class="dot" style="background:var(--beer)"></span>Bier</span>
        <span><span class="dot" style="background:var(--wine)"></span>Wein</span>
        <span style="display:flex;align-items:center;gap:6px"><svg width="20" height="10"><line x1="0" y1="5" x2="20" y2="5" stroke="var(--line)" stroke-width="2"/></svg>Kumulierte Linie</span>
      </div>
    </section>
  </div>

  <div class="bottom-sheet" id="sheet">
    <div class="sheet">
      <div class="row" style="margin-bottom:8px">
        <div class="drink-title">Einstellungen</div>
        <div style="display:flex;gap:8px">
          <button id="btnDefaults" class="btn">Standardwerte</button>
          <button id="btnClose" class="btn btn-primary">Fertig</button>
        </div>
      </div>

      <div class="grid-3">
        <div><label class="stat-label">Gewicht (kg)</label><input id="inWeight" type="number" class="input" inputmode="numeric" value="75"></div>
        <div><label class="stat-label">Geschlecht</label>
          <select id="inSex" class="input">
            <option value="m">männlich (r≈0.68)</option>
            <option value="f">weiblich (r≈0.55)</option>
          </select>
        </div>
        <div><label class="stat-label">Abbau-Rate β (‰/h)</label><input id="inBeta" type="number" class="input" step="0.01" inputmode="decimal" value="0.15"></div>
      </div>

      <h4 style="margin:14px 0 8px">Getränkespezifikation</h4>
      <div class="grid-2" id="specs"></div>

      <h4 style="margin:14px 0 8px">Sicherheit & Dynamik</h4>
      <div class="grid-2">
        <div class="card">
          <div class="toggle"><input type="checkbox" id="toggleAbsorb"><label for="toggleAbsorb">Aufnahmephase aktivieren</label></div>
          <div class="hint" style="margin:6px 0 8px">Alkohol wird über X Minuten verteilt freigesetzt.</div>
          <label class="stat-label">Dauer (Minuten)</label>
          <input id="inAbsorbMin" type="number" class="input" min="1" max="120" step="1" value="20">
        </div>
        <div class="card">
          <div class="toggle"><input type="checkbox" id="toggleLimit"><label for="toggleLimit">Maximal-Drinks Limit aktivieren</label></div>
          <div class="hint" style="margin:6px 0 8px">Zeigt ein Banner, wenn das Limit überschritten wird.</div>
          <label class="stat-label">Limit (Drinks)</label>
          <input id="inLimit" type="number" class="input" min="1" step="1" value="10">
        </div>
      </div>

      <div class="muted" style="font-size:12px;margin-top:10px">Gramm = ml × (%Vol/100) × 0,789. Bei cl: ml = cl × 10.</div>
    </div>
  </div>

  <script>
  'use strict';
  (function(){
    document.addEventListener('DOMContentLoaded', init);

    function init(){
      const ETHANOL_DENSITY = 0.789;
      const defaults = {
        specs:{
          shot:{unit:'cl', vol:2,  abv:40, label:'Shot'},
          longdrink:{unit:'cl', vol:4,  abv:40, label:'Long Drink'},
          beer:{unit:'ml', vol:500, abv:5,  label:'Bier'},
          wine:{unit:'ml', vol:200, abv:12, label:'Wein'}
        },
        weightKg:75,
        sex:'m',
        beta:0.15,
        absorbEnabled:false,
        absorbMinutes:20,
        limitEnabled:false,
        limitNumber:10,
        events:[] // {type, grams, time, unit, vol, abv}
      };

      const store = {
        get(){ try { return JSON.parse(localStorage.getItem('dt_state')||'{}'); } catch(e){ return {}; } },
        set(o){ localStorage.setItem('dt_state', JSON.stringify(o)); }
      };

      const state = Object.assign({}, defaults, store.get());
      state.specs = Object.assign({}, defaults.specs, state.specs||{});
      if(!Array.isArray(state.events)) state.events = [];

      // MIGRATION: Ältere Events ohne Snapshot mit defaults auffüllen (nur Anzeige)
      function withSnapshot(e){
        if(e.unit && (e.vol!=null) && (e.abv!=null)) return e;
        const s = state.specs[e.type] || {unit:'ml', vol:0, abv:0};
        return Object.assign({unit:s.unit, vol:s.vol, abv:s.abv}, e);
      }

      const el = {
        controls: document.getElementById('controls'),
        log: document.getElementById('log'),
        logEmpty: document.getElementById('log-empty'),
        statBac: document.getElementById('stat-bac'),
        statZero: document.getElementById('stat-zero'),
        statGrams: document.getElementById('stat-grams'),
        statStart: document.getElementById('stat-start'),
        gramsCard: document.getElementById('stat-grams-card'),
        flow: document.getElementById('flow'),
        sheet: document.getElementById('sheet'),
        btnSettings: document.getElementById('btnSettings'),
        btnClose: document.getElementById('btnClose'),
        btnDefaults: document.getElementById('btnDefaults'),
        btnReset: document.getElementById('btnReset'),
        banner: document.getElementById('limitBanner'),
        bannerClose: document.getElementById('closeBanner'),
        inWeight: document.getElementById('inWeight'),
        inSex: document.getElementById('inSex'),
        inBeta: document.getElementById('inBeta'),
        tAbs: document.getElementById('toggleAbsorb'),
        vAbs: document.getElementById('inAbsorbMin'),
        tLimit: document.getElementById('toggleLimit'),
        vLimit: document.getElementById('inLimit')
      };

      function gramsForSpec(unit, vol, abv){
        const ml = unit==='cl' ? vol*10 : vol;
        return ml * (abv/100) * ETHANOL_DENSITY;
      }
      function gramsFor(type){
        const s = state.specs[type];
        return gramsForSpec(s.unit, s.vol, s.abv);
      }

      function renderControls(){
        el.controls.innerHTML='';
        ['shot','longdrink','beer','wine'].forEach(type=>{
          const count = state.events.filter(e=>e.type===type).length;
          const spec = state.specs[type];
          const sub = spec.unit==='cl'
            ? `${spec.vol} cl @ ${spec.abv}% ≈ ${gramsFor(type).toFixed(1)} g`
            : `${spec.vol} ml @ ${spec.abv}% ≈ ${gramsFor(type).toFixed(1)} g`;
          const card = document.createElement('div');
          card.className='card';
          card.innerHTML = `
            <div>
              <div class="drink-title">${spec.label}</div>
              <div class="drink-sub">${sub}</div>
            </div>
            <div class="row">
              <div class="counter" id="count-${type}">${count}</div>
              <div style="display:flex;gap:8px">
                <button class="btn" data-minus="${type}">-</button>
                <button class="btn btn-primary" data-plus="${type}">+</button>
              </div>
            </div>`;
          el.controls.appendChild(card);
        });
      }

      function save(){ store.set(state); }

      function releasedGramsAt(t){
        if(state.events.length===0) return 0;
        let sum=0; const X=Math.max(1,state.absorbMinutes||20);
        for(const e0 of state.events){
          const e = withSnapshot(e0);
          if(!state.absorbEnabled){ if(t>=e.time) sum+=e.grams; }
          else{ const dt=(t-e.time)/60000; const f=Math.max(0, Math.min(1, dt/X)); sum+=e.grams*f; }
        }
        return sum;
      }

      function computeBAC(){
        const r = state.sex==='m'?0.68:0.55; const now=Date.now();
        if(state.events.length===0) return {bac:0,hoursToZero:0,totalGrams:0,first:null};
        const released = releasedGramsAt(now);
        const first = new Date(Math.min.apply(null, state.events.map(e=>e.time)));
        const hours = Math.max(0,(now-first.getTime())/3600000);
        let bac = (released/(r*state.weightKg)) - state.beta*hours; bac=Math.max(0,bac);
        const hoursToZero = bac<=0?0: bac/state.beta;
        const totalGrams = state.events.reduce((s,e)=>s+e.grams,0);
        return {bac,hoursToZero,totalGrams,first};
      }

      function fmtDur(h){ if(!isFinite(h)) return '–'; const m=Math.max(0,Math.round(h*60)); return `${Math.floor(m/60)}h ${m%60}m`; }
      function fmtTimeFromNow(h){ if(!isFinite(h)) return '–'; const t=new Date(Date.now()+Math.max(0,Math.round(h*60))*60000); return t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

      function renderStats(highlight){
        const r=computeBAC();
        el.statBac.textContent = r.bac.toFixed(2)+' ‰';
        el.statZero.textContent = fmtDur(r.hoursToZero) + (r.hoursToZero>0?` (~${fmtTimeFromNow(r.hoursToZero)} Uhr)`:'');
        el.statGrams.textContent = Math.round(r.totalGrams)+' g';
        el.statStart.textContent = r.first?r.first.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):'–';
        el.gramsCard.style.boxShadow = highlight? '0 0 0 2px rgba(239,68,68,.5) inset' : 'none';
      }

      function renderLog(){
        el.log.innerHTML='';
        if(state.events.length===0){ el.logEmpty.style.display='block'; return; }
        el.logEmpty.style.display='none';
        state.events.slice().reverse().forEach(e0 => {
          const e = withSnapshot(e0);
          const specText = e.unit==='cl' ? `${e.vol} cl @ ${e.abv}%` : `${e.vol} ml @ ${e.abv}%`;
          const li = document.createElement('li');
          li.innerHTML = `
            <div style="display:flex;align-items:center;gap:8px">
              <span class="pill" style="color:#e5e7eb;text-transform:capitalize">${e.type}</span>
              <span class="muted">${new Date(e.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
              <span class="muted">• ${specText}</span>
            </div>
            <span>${e.grams.toFixed(1)} g</span>`;
          el.log.appendChild(li);
        });
      }

      function renderFlow(){
        const svg=el.flow; svg.innerHTML=''; const width=640, height=260, pad=18, axisX=60;
        if(state.events.length===0){
          const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
          txt.setAttribute('x',10); txt.setAttribute('y',20); txt.setAttribute('fill','#9ca3af');
          txt.textContent='Noch keine Daten. Füge Getränke hinzu, um den Verlauf zu sehen.'; svg.appendChild(txt); return;
        }
        const data=state.events.slice().sort((a,b)=>a.time-b.time);
        const t0=data[0].time, t1=data[data.length-1].time, span=Math.max(1,t1-t0);
        let cum=0; const pts=data.map(d=>{cum++; const y=pad+((d.time-t0)/span)*(height-2*pad); const x=axisX+(cum/Math.max(1,data.length))*(width-axisX-pad); return {x,y,...d};});
        const axis=document.createElementNS('http://www.w3.org/2000/svg','line'); axis.setAttribute('x1',axisX); axis.setAttribute('y1',pad); axis.setAttribute('x2',axisX); axis.setAttribute('y2',height-pad); axis.setAttribute('stroke','#334155'); axis.setAttribute('stroke-width','2'); svg.appendChild(axis);
        const pl=document.createElementNS('http://www.w3.org/2000/svg','polyline'); pl.setAttribute('fill','none'); pl.setAttribute('stroke','var(--line)'); pl.setAttribute('stroke-width','2'); pl.setAttribute('points', pts.map(p=>p.x+','+p.y).join(' ')); svg.appendChild(pl);
        pts.forEach(p=>{ const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',5); const col=p.type==='shot'?'var(--shot)':p.type==='longdrink'?'var(--long)':p.type==='beer'?'var(--beer)':'var(--wine)'; c.setAttribute('fill',col); svg.appendChild(c); });
      }

      el.controls.addEventListener('click', (evt)=>{
        const plus = evt.target.getAttribute('data-plus');
        const minus = evt.target.getAttribute('data-minus');
        if(plus){
          // SNAPSHOT der aktuellen Spezifikation sichern
          const s = state.specs[plus];
          const grams = gramsForSpec(s.unit, s.vol, s.abv);
          state.events.push({type:plus, grams, time:Date.now(), unit:s.unit, vol:s.vol, abv:s.abv});
          save();
          if(state.limitEnabled && state.events.length>state.limitNumber){
            document.getElementById('limitVal').textContent = state.limitNumber;
            el.banner.classList.add('show');
            const c=document.getElementById('count-'+plus); if(c){ c.classList.add('shake'); setTimeout(()=>c.classList.remove('shake'),800); }
            renderStats(true); setTimeout(()=>renderStats(false), 10000);
          }
          updateUI();
        }
        if(minus){
          for(let i=state.events.length-1;i>=0;i--){ if(state.events[i].type===minus){ state.events.splice(i,1); break; } }
          save(); updateUI();
        }
      });

      el.btnSettings.onclick=()=>{ el.sheet.style.display='flex'; renderSpecs(); fillSettings(); };
      el.btnClose.onclick=()=>{ el.sheet.style.display='none'; };
      el.btnDefaults.onclick=()=>{ Object.assign(state, JSON.parse(JSON.stringify(defaults))); save(); renderSpecs(); updateUI(); };
      el.btnReset.onclick=()=>{ state.events=[]; save(); updateUI(); };
      el.bannerClose.onclick=()=>{ el.banner.classList.remove('show'); };

      function fillSettings(){
        el.inWeight.value=state.weightKg; el.inSex.value=state.sex; el.inBeta.value=state.beta;
        el.tAbs.checked=state.absorbEnabled; el.vAbs.value=state.absorbMinutes;
        el.tLimit.checked=state.limitEnabled; el.vLimit.value=state.limitNumber;
      }

      function renderSpecs(){
        const box=document.getElementById('specs'); box.innerHTML='';
        const add=(key,label,unit)=>{
          const d=document.createElement('div'); d.className='card';
          d.innerHTML=`<div class="drink-sub" style="margin-bottom:6px;color:#d1d5db">${label}</div>
          <label class="stat-label">Menge (${unit})</label>
          <input id="vol-${key}" type="number" class="input" step="${unit==='cl'?'0.5':'5'}" value="${state.specs[key].vol}">
          <label class="stat-label" style="margin-top:6px;display:block">Alkoholgehalt (% Vol.)</label>
          <input id="abv-${key}" type="number" class="input" step="0.5" value="${state.specs[key].abv}">
          <div class="muted" style="font-size:11px;margin-top:6px">≈ <span id="g-${key}"></span> g reiner Alkohol</div>`;
          box.appendChild(d);
        };
        add('shot','Shot','cl'); add('longdrink','Long Drink','cl'); add('beer','Bier','ml'); add('wine','Wein','ml');
        ['shot','longdrink','beer','wine'].forEach(k=>{
          const vol=document.getElementById('vol-'+k); const abv=document.getElementById('abv-'+k);
          const upd=()=>{ state.specs[k].vol=parseFloat(vol.value)||0; state.specs[k].abv=parseFloat(abv.value)||0; document.getElementById('g-'+k).textContent=gramsFor(k).toFixed(1); save(); renderControls(); };
          vol.oninput=upd; abv.oninput=upd; upd();
        });
        el.inWeight.oninput=()=>{ state.weightKg=parseFloat(el.inWeight.value)||0; save(); updateUI(); };
        el.inSex.onchange=()=>{ state.sex=el.inSex.value; save(); updateUI(); };
        el.inBeta.oninput=()=>{ state.beta=parseFloat(el.inBeta.value)||0; save(); updateUI(); };
        el.tAbs.onchange=()=>{ state.absorbEnabled=el.tAbs.checked; save(); updateUI(); };
        el.vAbs.oninput=()=>{ state.absorbMinutes=Math.max(1, parseInt(el.vAbs.value)||20); save(); updateUI(); };
        el.tLimit.onchange=()=>{ state.limitEnabled=el.tLimit.checked; save(); updateUI(); };
        el.vLimit.oninput=()=>{ state.limitNumber=Math.max(1, parseInt(el.vLimit.value)||10); save(); updateUI(); };
      }

      function updateUI(){
        renderControls(); renderStats(); renderLog(); renderFlow();
      }

      setInterval(function(){ renderStats(); }, 30000);
      updateUI();
    }
  })();
  </script>
</body>
</html>
